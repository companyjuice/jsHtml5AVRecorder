/**
 * Object:  jsHtml5AudioRecorder
 * Version: master
 * Author:  Edouard Kombo
 * Twitter: @EdouardKombo
 * Github:  https://github.com/edouardkombo
 * Blog:    http://creativcoders.wordpress.com
 * Url:     https://github.com/edouardkombo/jsHtml5AudioRecorder
 * 
 * Dual licensed under the MIT and GPL licenses:
 * http://www.opensource.org/licenses/mit-license.php
 * http://www.gnu.org/licenses/gpl.html
 * 
 * Record live audio stream in html5 with echo cancellation, save it on server or download directly from browser
 */

var jsHtml5AudioRecorder=function(){};jsHtml5AudioRecorder.prototype={audioContext:"",Recorder:false,mediaPath:"",audioExtension:"",audioLink:"",phpFile:"",fftSize:2048,audioTagId:"audio",showStreamOnFinish:false,init:function(){if(!navigator.getUserMedia){navigator.getUserMedia=navigator.webkitGetUserMedia||navigator.mozGetUserMedia}try{this.audioContext=new AudioContext;console.log("Audio context set up.");console.log("navigator.getUserMedia "+(navigator.getUserMedia?"available.":"not present!"))}catch(e){alert("No web audio support in this browser!")}window.onload=this.onLoad()},onLoad:function(){navigator.getUserMedia({audio:true},this.startStream.bind(this),function(e){alert("No audio stream!");console.log(e)})},startStream:function(e){var t=this.audioContext.createGain();var n=this.audioContext.createMediaStreamSource(e);n.connect(t);var r=this.audioContext.createAnalyser();r.fftSize=this.fftSize;t.connect(r);this.Recorder=new Recorder(t);var i=this.audioContext.createGain();i.gain.value=0;i.connect(this.audioContext.destination)},startRecording:function(){var e=document.getElementById(this.audioTagId);if(e){e.remove()}this.Recorder&&this.Recorder.record();console.log("Recording audio...")},stopRecording:function(e){this.Recorder&&this.Recorder.stop();this.Recorder&&this.Recorder.exportWAV(function(t){console.log(t);if(e==="save"){this.save(t,false)}else if(e==="download"){this.download(t,false)}else if(e==="stream"){this.stream(t)}else if(e==="saveAndDownload"){this.save(t,false);this.download(t,false)}else if(e==="saveAndStream"){this.save(t,true)}else if(e==="downloadAndStream"){this.download(t,true)}else{this.save(t,false)}}.bind(this));this.Recorder.clear();console.log("Stop Recording audio!")},save:function(e,t){var n="path="+this.mediaPath+"&extension="+this.audioExtension;var r=new XMLHttpRequest;r.onreadystatechange=function(){if(r.readyState===4&&r.status===200){console.log(r.response);this.audioLink=r.response;if(t){this.stream(e)}}}.bind(this);r.open("post",this.phpFile+"?"+n,true);r.setRequestHeader("X-Requested-With","XMLHttpRequest");r.setRequestHeader("cache-Control","no-store, no-cache, must-revalidate");r.setRequestHeader("cache-Control","post-check=0, pre-check=0");r.setRequestHeader("cache-Control","max-age=0");r.setRequestHeader("Pragma","no-cache");r.setRequestHeader("X-File-Name",encodeURIComponent("1"));r.setRequestHeader("Content-Type","application/octet-stream");r.send(e)},download:function(e,t){var n=window.URL.createObjectURL(e);var r=document.createElement("a");var i=(new Date).toISOString();r.href=n;r.id=i;r.download=i+"."+this.audioExtension;r.innerHTML=r.download;r.style.display="none";r.style.visibility="hidden";document.body.appendChild(r);document.getElementById(r.id).click();document.getElementById(r.id).remove();if(t){this.stream(e)}},stream:function(e){var t=window.URL.createObjectURL(e);var n=document.createElement("audio");n.src=t;n.id=this.audioTagId;if(this.showStreamOnFinish){n.style.display="block";n.style.visibility="visible"}else{n.style.display="none";n.style.visibility="hidden"}document.body.appendChild(n);n.setAttribute("autoplay",false);n.setAttribute("controls",true);n.pause()}}
