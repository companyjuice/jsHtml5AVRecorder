/**
 * Object:  jsHtml5VideoRecorder
 * Version: master
 * Author:  Edouard Kombo
 * Twitter: @EdouardKombo
 * Github:  https://github.com/edouardkombo
 * Blog:    http://creativcoders.wordpress.com
 * Url:     https://github.com/edouardkombo/jsHtml5VideoRecorder
 * 
 * Dual licensed under the MIT and GPL licenses:
 * http://www.opensource.org/licenses/mit-license.php
 * http://www.gnu.org/licenses/gpl.html
 * 
 * Record live video stream in html5 with automatic fps, stream it, save it on server or download directly from browser
 */

var jsHtml5VideoRecorder=function(){};jsHtml5VideoRecorder.prototype={url:0,hasStopped:false,whammy:false,mediaStream:"",videoTagId:"video",canvasTagId:"canvas",videoTag:0,canvasTag:0,ctx:0,frames:[],startTime:0,endTime:0,rafId:0,maxRecordTime:0,width:0,height:0,mediaPath:"",phpFile:"",videoTagIdHost:"",resultTagIdHost:"",resultTagId:"",showStreamOnFinish:"",hideWebcamWhileRecording:true,videoLink:"",init:function(){if(!navigator.getUserMedia){navigator.getUserMedia=navigator.webkitGetUserMedia||navigator.mozGetUserMedia}window.URL=window.URL||window.webkitURL;this.url=window.URL;window.onload=this.onLoad()},onLoad:function(){navigator.getUserMedia({video:true},this.startUserMedia.bind(this),function(e){console.log("No live video stream: "+e);alert("Webcam not enabled or no live video stream")})},startUserMedia:function(e){this.mediaStream=e;this.resetTags()},resetTags:function(){this.createTag("video",this.videoTagId);this.createTag("canvas",this.canvasTagId)},createTag:function(e,t){var n=document.getElementById(t);if(n===null){n=document.createElement(e);if(e==="canvas"){n.width=this.width;n.height=this.height;n.id=t;n.style.position="absolute";n.style.visibility="hidden";this.ctx=n.getContext("2d");this.canvasTag=this.ctx.canvas}else if(e==="video"){n.setAttribute("autoplay","true");n.width=this.width;n.height=this.height;n.id=t;if(this.mediaStream!==""){n.src=window.URL.createObjectURL(this.mediaStream)}this.videoTag=n}document.getElementById(this.videoTagIdHost).appendChild(n)}},drawVideoFrame_:function(e){this.ctx.drawImage(this.videoTag,0,0,this.videoTag.width,this.videoTag.height);var t=this.canvasTag.toDataURL("image/webp",1);this.frames.push(t);this.rafId=requestAnimationFrame(this.drawVideoFrame_.bind(this))},startRecording:function(){var e=document.getElementById(this.resultTagId);if(e){e.remove()}this.resetTags();if(this.hideWebcamWhileRecording){this.showHideStream("hide")}this.hasStopped=false;this.startTime=Date.now();this.frames=[];console.log("Recording video...");this.rafId=requestAnimationFrame(this.drawVideoFrame_.bind(this));return true},showHideStream:function(e){if(e==="show"){this.videoTag.style.visibility="visible";this.videoTag.style.display="block"}else if(e==="hide"){this.videoTag.style.visibility="hidden";this.videoTag.style.display="none"}},stopRecording:function(e){this.endTime=Date.now();this.hasStopped=true;cancelAnimationFrame(this.rafId);var t=(this.endTime-this.startTime)/1e3;console.log("Captured frames: "+this.frames.length+" => "+t+"s video");var n=this.maxRecordTime-t;var r=(this.frames.length/t).toFixed(1);var i=r;var s=n<=1?i*this.maxRecordTime:i*t;var o=this.frames.length-s;if(o>0){var u=0;for(u=0;u<=o;u++){this.frames.pop()}}else{i=(this.frames.length*r/s).toFixed(3)}console.log("Stop Recording video!");console.log("My FPS => "+r);console.log(i);var a=this.whammy.fromImageArray(this.frames,i);console.log(a);if(e==="save"){this.save(a,false)}else if(e==="download"){this.download(a,false)}else if(e==="stream"){this.stream(a)}else if(e==="saveAndDownload"){this.save(webmBlob,false);this.download(a,false)}else if(e==="saveAndStream"){this.save(a,true)}else if(e==="downloadAndStream"){this.download(a,true)}else{this.save(a,false)}if(this.showStreamOnFinish){this.showHideStream("show")}this.frames=[];return true},save:function(e,t){var n="path="+this.mediaPath+"&extension="+this.videoExtension;var r=new XMLHttpRequest;r.onreadystatechange=function(){if(r.readyState===4&&r.status===200){console.log(r.response);this.videoLink=r.response;if(t){this.stream(e)}}}.bind(this);r.open("post",this.phpFile+"?"+n,true);r.setRequestHeader("X-Requested-With","XMLHttpRequest");r.setRequestHeader("cache-Control","no-store, no-cache, must-revalidate");r.setRequestHeader("cache-Control","post-check=0, pre-check=0");r.setRequestHeader("cache-Control","max-age=0");r.setRequestHeader("Pragma","no-cache");r.setRequestHeader("X-File-Name",encodeURIComponent("1"));r.setRequestHeader("Content-Type","application/octet-stream");r.send(e)},download:function(e,t){var n=window.URL.createObjectURL(e);var r=document.createElement("a");var i=(new Date).toISOString();r.href=n;r.id=i;r.download=i+"."+this.videoExtension;r.innerHTML=r.download;r.style.display="none";r.style.visibility="hidden";document.body.appendChild(r);document.getElementById(r.id).click();document.getElementById(r.id).remove();if(t){this.stream(e)}},stream:function(e){var t=window.URL.createObjectURL(e);var n=document.createElement("video");n.src=t;n.setAttribute("autoplay",false);n.setAttribute("controls",true);n.id=this.resultTagId;document.getElementById(this.resultTagIdHost).appendChild(n);n.pause()}}