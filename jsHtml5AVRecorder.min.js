/**
 * Object:  jsHtml5AVRecorder
 * Version: master
 * Author:  Edouard Kombo
 * Twitter: @EdouardKombo
 * Github:  https://github.com/edouardkombo
 * Blog:    http://creativcoders.wordpress.com
 * Url:     https://github.com/edouardkombo/jsHtml5AVRecorder
 * 
 * Dual licensed under the MIT and GPL licenses:
 * http://www.opensource.org/licenses/mit-license.php
 * http://www.gnu.org/licenses/gpl.html
 * 
 * Record both audio and video in html5 and convert them into mp4.
 */

var jsHtml5AVRecorder=function(){};jsHtml5AVRecorder.prototype={audioWrapper:"",videoWrapper:"",convertFilesTo:"",phpFile:"",mediaPath:"",uniqueMedia:"",deleteSeparatedFiles:true,doConversion:"",streamConvertedResult:"",streamResult:true,init:function(){if(this.audioWrapper!==""&&this.videoWrapper!==""){this.audioWrapper.init();this.videoWrapper.init();window.addEventListener("click",function(){if(this.event.target.id){if(this.event.target.id===this.jsAVRecorder.videoWrapper.resultTagIdHost||this.event.target.id===this.jsAVRecorder.videoWrapper.resultTagId){if(this.jsAVRecorder.streamResult){this.jsAVRecorder.streamAll()}}}},false)}},startRecording:function(){this.audioWrapper.startRecording();this.videoWrapper.startRecording()},stopRecording:function(e){this.audioWrapper.stopRecording(e);this.videoWrapper.stopRecording(e);if(this.doConversion){this.prepareToConversion()}},prepareToConversion:function(){setTimeout(function(){if(this.videoWrapper.videoLink!==""&&this.audioWrapper.audioLink!==""){this.convert()}clearTimeout()}.bind(this),1e3)},streamAll:function(){var e=document.getElementById(this.videoWrapper.resultTagId);var t=document.getElementById(this.audioWrapper.audioTagId);if(e.paused){e.play();t.play();console.log("Play all")}else{e.currentTime=0;t.currentTime=0;e.pause();t.pause();console.log("Pause all")}},convert:function(){var e="path="+this.mediaPath+"&deleteSeparatedFiles="+this.deleteSeparatedFiles+"&audioFileName="+this.audioWrapper.audioLink+"&videoFileName="+this.videoWrapper.videoLink+"&extension="+this.convertFilesTo;console.log();var t=new XMLHttpRequest;t.onreadystatechange=function(){if(t.readyState===4&&t.status===200){console.log(t.response);this.uniqueMedia=t.response;if(this.streamConvertedResult){this.streamResult=false;document.getElementById(this.videoWrapper.resultTagId).remove();var e=document.createElement("video");e.src=this.uniqueMedia;e.setAttribute("autoplay",false);e.setAttribute("controls",true);e.id=this.videoWrapper.resultTagId;document.getElementById(this.videoWrapper.resultTagIdHost).appendChild(e);e.pause()}}}.bind(this);t.open("post",this.phpFile+"?"+e,true);t.setRequestHeader("X-Requested-With","XMLHttpRequest");t.setRequestHeader("cache-Control","no-store, no-cache, must-revalidate");t.setRequestHeader("cache-Control","post-check=0, pre-check=0");t.setRequestHeader("cache-Control","max-age=0");t.setRequestHeader("Pragma","no-cache");t.setRequestHeader("X-File-Name",encodeURIComponent("1"));t.setRequestHeader("Content-Type","application/octet-stream");t.send()}}
